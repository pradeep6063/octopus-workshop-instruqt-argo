step "sql-create-database-if-not-exists" {
    name = "SQL - Create Database If Not Exists"

    action {
        properties = {
            createCommandTimeout = "30"
            createDatabaseName = "#{SQLServer.Database.Name}"
            createSqlDatabaseRetryAttempts = "0"
            createSqlLoginPasswordWhoHasRights = "#{SQLServer.Database.Password}"
            createSqlLoginUserWhoHasCreateUserRights = "#{SQLServer.Database.UserName}"
            createSqlServer = "#{SQLServer.Database.Host}"
            Octopus.Action.Template.Id = "ActionTemplates-2"
            Octopus.Action.Template.Version = "5"
            OctopusUseBundledTooling = "False"
        }
        worker_pool = "hosted-ubuntu"

        container {
            feed = "docker-hub"
            image = "octopusdeploy/worker-tools:6.5.0-ubuntu.22.04"
        }
    }
}

process_template "run-a-process-template" {
    name = "Run a Process Template"
    process_template_slug = "flyway-database-migration"
    version_mask = "2.X"

    package_parameter "parameter.database.package" {
        feed = "github-repository-feed"
        package_id = "adamoctoclose/octopus-workshop-instruqt-argo"
    }

    parameter "parameter.worker.pool" {
        value = "WorkerPools-62"
    }

    parameter "parameter.database.name" {
        value = "sample"
    }

    parameter "parameter.database.user" {
        value = "#{SQLServer.Database.UserName}"
    }

    parameter "parameter.database.password" {
        value = "#{SQLServer.Database.Password}"
    }

    parameter "parameter.database.host" {
        value = "#{SQLServer.Database.Host}"
    }

    parameter "parameter.container.feed" {
        value = "Feeds-1044"
    }
}